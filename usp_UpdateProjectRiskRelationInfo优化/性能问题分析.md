# usp_UpdateProjectRiskRelationInfo å­˜å‚¨è¿‡ç¨‹æ€§èƒ½é—®é¢˜åˆ†æ

## ä¸€ã€å­˜å‚¨è¿‡ç¨‹æ¦‚è¿°

**å­˜å‚¨è¿‡ç¨‹åç§°**: `dbo.usp_UpdateProjectRiskRelationInfo`

**åŠŸèƒ½æè¿°**: æ¯å¤©0ç‚¹å®šæ—¶åˆ·æ–°åˆåŒé£é™©éœ€è¦ä½¿ç”¨çš„ç›¸å…³ä¿¡æ¯

**ä¸»è¦è®¡ç®—å†…å®¹**:
- åˆåŒçŠ¶æ€
- ç¬¬ä¸€æ¬¡æ‰“åœŸæ—¥æœŸ
- é¡¹ç›®ç´¯è®¡ä¾›åº”æ•°é‡
- é¡¹ç›®ç´¯è®¡äº§å€¼
- é¡¹ç›®ç´¯è®¡å›æ¬¾
- é¡¹ç›®å›æ¬¾ç‡
- æœªåŠç†ç»“ç®—é‡‘é¢
- é¡¹ç›®ç»“ç®—é‡‘é¢

## äºŒã€æ¶‰åŠçš„ä¸»è¦è¡¨åŠæ•°æ®é‡

| è¡¨å | è¡Œæ•° | å ç”¨ç©ºé—´ | ç”¨é€” |
|------|------|----------|------|
| ProductionDailyReportDetails | 34,472,505 | 5.47 GB | ç”Ÿäº§æ—¥æŠ¥è¯¦æƒ…ï¼ˆæœ€å¤§è¡¨ï¼‰|
| AccountReceivable | 8,441,365 | 1.08 GB | åº”æ”¶è´¦æ¬¾ |
| FinanceReports | 593,110 | 31 MB | è´¢åŠ¡æŠ¥å‘Š |
| SalesPayment | 296,055 | 30 MB | é”€å”®å›æ¬¾ |
| SalesStatements | 252,160 | 66 MB | é”€å”®ç»“ç®—å• |
| ProductionDailyReports | 247,073 | 16 MB | ç”Ÿäº§æ—¥æŠ¥ä¸»è¡¨ |
| Project | 183,768 | 29 MB | é¡¹ç›®è¡¨ |
| ProjectRiskRelationInfo | 56,608 | 6 MB | é¡¹ç›®é£é™©å…³ç³»è¡¨ï¼ˆç›®æ ‡è¡¨ï¼‰|
| SalesIncomeAdjustment | 62,196 | 10 MB | é”€å”®æ”¶å…¥è°ƒæ•´ |
| SalesServiceIncome | 50,180 | 9 MB | é”€å”®æœåŠ¡æ”¶å…¥ |
| SalesContracts | 48,705 | 18 MB | é”€å”®åˆåŒ |

## ä¸‰ã€ä¸»è¦ï¿½ï¿½èƒ½é—®é¢˜

### é—®é¢˜1: å¤§é‡ä½¿ç”¨ WITH (NOLOCK)

**ä½ç½®**: å‡ ä¹æ‰€æœ‰æŸ¥è¯¢

**é—®é¢˜æè¿°**:
- NOLOCKæç¤ºå¯èƒ½å¯¼è‡´è„è¯»
- åœ¨å®šæ—¶ä»»åŠ¡ä¸­ï¼Œè„è¯»å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- å»ºè®®ä½¿ç”¨ READ COMMITTED SNAPSHOT æˆ–é€‚å½“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«

**å½±å“**: æ•°æ®å‡†ç¡®æ€§é£é™©

---

### é—®é¢˜2: æ ‡é‡å­æŸ¥è¯¢åœ¨ WHERE æ¡ä»¶ä¸­

**ä½ç½®**:
- ç¬¬49è¡Œ: `(SELECT ParaValue FROM dbo.Parameters WHERE ParaName='ProjectSalesTypeFilter')`
- ç¬¬126è¡Œ: åŒæ ·çš„å­æŸ¥è¯¢é‡å¤å‡ºç°

**é—®é¢˜æè¿°**:
- æ ‡é‡å­æŸ¥è¯¢ä¼šä¸ºæ¯è¡Œæ•°æ®æ‰§è¡Œä¸€æ¬¡
- ç›¸åŒçš„å­æŸ¥è¯¢è¢«æ‰§è¡Œä¸¤æ¬¡
- å¯¹äº3400ä¸‡è¡Œçš„è¡¨ï¼Œè¿™ä¼šå¯¼è‡´å¤§é‡é‡å¤æŸ¥è¯¢

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æå‰å£°æ˜å˜é‡
DECLARE @ProjectSalesTypeFilter NVARCHAR(MAX) =
    (SELECT ParaValue FROM dbo.Parameters WHERE ParaName='ProjectSalesTypeFilter');
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘æ•°ç™¾ä¸‡æ¬¡é‡å¤æŸ¥è¯¢

---

### é—®é¢˜3: ä¸´æ—¶è¡¨ç¼ºå°‘ç´¢å¼•

**ä½ç½®**: æ‰€æœ‰ä¸´æ—¶è¡¨ (#TempProj, #TempProduct, #TempBLastNR ç­‰)

**é—®é¢˜æè¿°**:
- ä¸´æ—¶è¡¨åˆ›å»ºåæ²¡æœ‰åˆ›å»ºç´¢å¼•
- åç»­ JOIN æ“ä½œä¼šå¯¼è‡´å…¨è¡¨æ‰«æ
- ç‰¹åˆ«æ˜¯ä¸å¤§è¡¨ JOIN æ—¶æ€§èƒ½å½±å“ä¸¥é‡

**ä¼˜åŒ–å»ºè®®**:
```sql
-- ç¤ºä¾‹: ä¸ºä¸´æ—¶è¡¨æ·»åŠ ç´¢å¼•
CREATE CLUSTERED INDEX IX_TempProj_ProjectID ON #TempProj(ProjectID);
CREATE INDEX IX_TempBLastNR_ProjectID ON #TempBLastNR(ProjectID);
CREATE INDEX IX_TempCurrentSales_ProjectID ON #TempCurrentSales(ProjectID);
```

**é¢„æœŸæ•ˆæœ**: JOIN æ€§èƒ½æå‡ 10-100 å€

---

### é—®é¢˜4: ProductionDailyReportDetails è¡¨çš„å…¨è¡¨æ‰«æ

**ä½ç½®**: ç¬¬34-50è¡Œ, ç¬¬116-128è¡Œ

**é—®é¢˜æè¿°**:
- å¯¹3400ä¸‡è¡Œçš„è¡¨è¿›è¡ŒæŸ¥è¯¢
- è™½ç„¶æœ‰ WHERE æ¡ä»¶,ä½†å¯èƒ½æ²¡æœ‰æœ€ä¼˜ç´¢å¼•
- Type å­—æ®µçš„ IN æŸ¥è¯¢ä½¿ç”¨äº†å‡½æ•°åˆ†å‰²å­—ç¬¦ä¸²

**å½“å‰ç´¢å¼•**:
```sql
IX_DailyReportID - (DailyReportID, ...)
IX_ProjectID - (ProjectID, DailyReportID, ReceiptDate)
```

**ä¼˜åŒ–å»ºè®®**:
1. ç¡®ä¿ç´¢å¼•è¦†ç›–æŸ¥è¯¢åˆ—
2. è€ƒè™‘æ·»åŠ  ReceiptDate çš„ç´¢å¼•
3. é¿å…åœ¨ IN å­å¥ä¸­ä½¿ç”¨å‡½æ•°

**é¢„æœŸæ•ˆæœ**: æŸ¥è¯¢æ—¶é—´å‡å°‘ 50-90%

---

### é—®é¢˜5: AccountReceivable è¡¨çš„é‡å¤æŸ¥è¯¢

**ä½ç½®**: ç¬¬74-89è¡Œ å’Œ ç¬¬102-113è¡Œ

**é—®é¢˜æè¿°**:
- å¯¹åŒä¸€ä¸ªå¤§è¡¨ (840ä¸‡è¡Œ) è¿›è¡Œäº†ä¸¤æ¬¡ç±»ä¼¼çš„æŸ¥è¯¢
- ä¸€æ¬¡æŸ¥è¯¢ PeriodID - 3, å¦ä¸€æ¬¡æŸ¥è¯¢ PeriodID - 2
- å¯ä»¥åˆå¹¶ä¸ºä¸€æ¬¡æŸ¥è¯¢

**ä¼˜åŒ–å»ºè®®**:
```sql
-- åˆå¹¶æŸ¥è¯¢,ä½¿ç”¨ CASE åŒºåˆ†ä¸åŒPeriod
SELECT
    ProjectID,
    SUM(CASE WHEN PeriodID = @PeriodID - 3 THEN ... END) AS LastN3Value,
    SUM(CASE WHEN PeriodID = @PeriodID - 2 THEN ... END) AS LastN2Value
FROM AccountReceivable
WHERE PeriodID IN (@PeriodID - 3, @PeriodID - 2)
GROUP BY ProjectID
```

**é¢„æœŸæ•ˆæœ**: I/O å‡å°‘çº¦ 50%

---

### é—®é¢˜6: æ—¥æœŸè®¡ç®—åœ¨ WHERE å­å¥ä¸­é‡å¤æ‰§è¡Œ

**ä½ç½®**:
- ç¬¬125è¡Œ: `DATEADD(MM, DATEDIFF(MM, 0, DATEADD(MM, -1, GETDATE())), 0)`
- ç¬¬157è¡Œ: `DATEADD(MM, DATEDIFF(MM, 0, DATEADD(MM, -2, GETDATE())), 0)`
- ç¬¬168è¡Œ: åŒæ ·çš„è®¡ç®—é‡å¤

**é—®é¢˜æè¿°**:
- å¤æ‚çš„æ—¥æœŸè®¡ç®—ä¼šä¸ºæ¯è¡Œæ•°æ®æ‰§è¡Œ
- GETDATE() æ¯æ¬¡è°ƒç”¨ç»“æœå¯èƒ½ä¸åŒ
- å½±å“æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æ€§èƒ½ä¼°ç®—

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æå‰è®¡ç®—å¹¶å­˜å‚¨åœ¨å˜é‡ä¸­
DECLARE @StartDate_2MonthsAgo DATE = DATEADD(MM, DATEDIFF(MM, 0, DATEADD(MM, -2, GETDATE())), 0);
DECLARE @StartDate_1MonthAgo DATE = DATEADD(MM, DATEDIFF(MM, 0, DATEADD(MM, -1, GETDATE())), 0);
DECLARE @CurrentDate DATE = CAST(GETDATE() AS DATE);
```

**é¢„æœŸæ•ˆæœ**: æå‡æŸ¥è¯¢æ€§èƒ½ 5-15%

---

### é—®é¢˜7: UPDATE è¯­å¥ä½¿ç”¨ NOLOCK æç¤º

**ä½ç½®**: ç¬¬300-323è¡Œ

**é—®é¢˜æè¿°**:
```sql
UPDATE prri
FROM ProjectRiskRelationInfo prri WITH (NOLOCK)
```

**ä¸¥é‡é—®é¢˜**:
- UPDATE è¯­å¥ä¸­ä½¿ç”¨ NOLOCK æ˜¯é”™è¯¯çš„
- å¯èƒ½å¯¼è‡´æ›´æ–°ä¸¢å¤±æˆ–æ•°æ®æŸå
- NOLOCK åªåº”ç”¨äº SELECT è¯­å¥

**ä¼˜åŒ–å»ºè®®**:
```sql
-- ç§»é™¤ NOLOCK
UPDATE prri
FROM ProjectRiskRelationInfo prri
    LEFT JOIN #TempData ON #TempData.ProjectID = prri.ProjectID;
```

**é¢„æœŸæ•ˆæœ**: æ•°æ®ä¸€è‡´æ€§ä¿éšœ

---

### é—®é¢˜8: INSERT è¯­å¥çš„ NOT EXISTS æ£€æŸ¥

**ä½ç½®**: ç¬¬373-378è¡Œ

**é—®é¢˜æè¿°**:
- NOT EXISTS ä¼šå¯¹æ¯æ¡è®°å½•æ‰§è¡Œå­æŸ¥è¯¢
- å¯ä»¥ä½¿ç”¨ LEFT JOIN IS NULL ä»£æ›¿
- æˆ–è€…ä½¿ç”¨ MERGE è¯­å¥åŒæ—¶å¤„ç† UPDATE å’Œ INSERT

**ä¼˜åŒ–å»ºè®®**:
```sql
-- æ–¹æ¡ˆ1: LEFT JOIN
INSERT INTO dbo.ProjectRiskRelationInfo (...)
SELECT ...
FROM #TempData t
    LEFT JOIN ProjectRiskRelationInfo prri ON prri.ProjectID = t.ProjectID
WHERE prri.ProjectID IS NULL;

-- æ–¹æ¡ˆ2: MERGE (æ¨è)
MERGE INTO dbo.ProjectRiskRelationInfo AS target
USING #TempData AS source ON target.ProjectID = source.ProjectID
WHEN MATCHED THEN UPDATE SET ...
WHEN NOT MATCHED THEN INSERT (...) VALUES (...);
```

**é¢„æœŸæ•ˆæœ**: æ€§èƒ½æå‡ 20-50%, ä»£ç æ›´ç®€æ´

---

### é—®é¢˜9: è¡¨valuedå‡½æ•° f_split çš„æ€§èƒ½é—®é¢˜

**ä½ç½®**: ç¬¬49è¡Œ, ç¬¬126è¡Œ

**é—®é¢˜æè¿°**:
```sql
dbo.f_split((SELECT ParaValue...), ',')
```

- è¡¨å€¼å‡½æ•°åœ¨å¤§æ•°æ®é›†ä¸Šæ€§èƒ½è¾ƒå·®
- å»ºè®®ä½¿ç”¨ STRING_SPLIT (SQL Server 2016+)
- æˆ–è€…ä½¿ç”¨ä¸´æ—¶è¡¨é¢„å…ˆåˆ†å‰²

**ä¼˜åŒ–å»ºè®®**:
```sql
-- ï¿½ï¿½ï¿½ç”¨ STRING_SPLIT
DECLARE @TypeFilter TABLE (Value NVARCHAR(100));
INSERT INTO @TypeFilter
SELECT value FROM STRING_SPLIT(@ProjectSalesTypeFilter, ',');

-- ç„¶åä½¿ç”¨ INNER JOIN
INNER JOIN @TypeFilter tf ON d.Type = tf.Value
```

**é¢„æœŸæ•ˆæœ**: æ€§èƒ½æå‡ 30-70%

---

### é—®é¢˜10: ç¼ºå°‘äº‹åŠ¡æ§åˆ¶

**ä½ç½®**: æ•´ä¸ªå­˜å‚¨è¿‡ç¨‹

**é—®é¢˜æè¿°**:
- UPDATE å’Œ INSERT æ“ä½œæ²¡æœ‰æ˜¾å¼äº‹åŠ¡
- å¦‚æœä¸­é€”å¤±è´¥,å¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®æ›´æ–°
- ç¼ºå°‘é”™è¯¯å¤„ç†æœºåˆ¶

**ä¼˜åŒ–å»ºè®®**:
```sql
BEGIN TRY
    BEGIN TRANSACTION;

    -- æ‰€æœ‰æ“ä½œ

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;

    THROW;
END CATCH;
```

**é¢„æœŸæ•ˆæœ**: æ•°æ®ä¸€è‡´æ€§ä¿éšœ

---

## å››ã€ç´¢å¼•å»ºè®®

### 4.1 éœ€è¦éªŒè¯/æ·»åŠ çš„ç´¢å¼•

#### ProductionDailyReportDetails è¡¨
```sql
-- æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ 
CREATE INDEX IX_ProductionDetails_Type_ReportID
ON ProductionDailyReportDetails(Type, DailyReportID)
INCLUDE (ProjectID, ReceiptDate, FinalQty_M3, FinalQty_T, SalesTotalAmt1, Unit);
```

#### AccountReceivable è¡¨
```sql
-- ä¼˜åŒ– PeriodID æŸ¥è¯¢
CREATE INDEX IX_AccountReceivable_PeriodID_ProjectID
ON AccountReceivable(PeriodID, ProjectID, isDeleted)
INCLUDE (FinanceRptID, CurrentACCUSalesIncomeTotalAmt, CurrentACCUFinalQty_T,
         CurrentACCUFinalQty_M3, CurrentACCUSalesIncomeAdjAdjustQty_T,
         CurrentACCUSalesIncomeAdjAdjustQty_M3, CurrentACCUSalesPayTotalAmt);
```

#### SalesPayment è¡¨
```sql
-- ä¼˜åŒ–æ—¥æœŸèŒƒå›´æŸ¥è¯¢
CREATE INDEX IX_SalesPayment_PaymentDate_ProjectID
ON SalesPayment(PaymentDate, ProjectID, isDeleted)
INCLUDE (Amount);
```

#### SalesServiceIncome è¡¨
```sql
CREATE INDEX IX_SalesServiceIncome_PaymentDate_Type
ON SalesServiceIncome(PaymentDate, ServiceType, ProjectID, isDeleted)
INCLUDE (RefundAmt);
```

#### SalesStatements è¡¨
```sql
CREATE INDEX IX_SalesStatements_ProjectID_Calculated
ON SalesStatements(ProjectID, isDeleted, IsVoid, ifCalculate)
INCLUDE (SalesAmt, SignDate);
```

#### ProjectRiskRelationInfo è¡¨
```sql
-- ç¡®ä¿æœ‰é«˜æ•ˆçš„ä¸»é”®/å”¯ä¸€ç´¢å¼•
CREATE UNIQUE NONCLUSTERED INDEX IX_ProjectRiskRelationInfo_ProjectID
ON ProjectRiskRelationInfo(ProjectID);
```

---

## äº”ã€ä¼˜åŒ–ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ (ç«‹å³ä¼˜åŒ–)
1. â— ç§»é™¤ UPDATE è¯­å¥ä¸­çš„ NOLOCK (é—®é¢˜7)
2. â— ä¸ºä¸´æ—¶è¡¨æ·»åŠ ç´¢å¼• (é—®é¢˜3)
3. â— ä½¿ç”¨å˜é‡æ›¿ä»£æ ‡é‡å­æŸ¥è¯¢ (é—®é¢˜2)
4. â— æ·»åŠ äº‹åŠ¡å’Œé”™è¯¯å¤„ç† (é—®é¢˜10)

### ä¸­ä¼˜å…ˆçº§ (è¿‘æœŸä¼˜åŒ–)
5. ğŸ”¶ ä¼˜åŒ–æ—¥æœŸï¿½ï¿½ï¿½ç®— (é—®é¢˜6)
6. ğŸ”¶ åˆå¹¶ AccountReceivable æŸ¥è¯¢ (é—®é¢˜5)
7. ğŸ”¶ ä½¿ç”¨ MERGE æ›¿ä»£ UPDATE + INSERT (é—®é¢˜8)
8. ğŸ”¶ ä¼˜åŒ– f_split å‡½æ•°è°ƒç”¨ (é—®é¢˜9)

### ä½ä¼˜å…ˆçº§ (é•¿æœŸä¼˜åŒ–)
9. ğŸ”¹ éªŒè¯å’Œæ·»åŠ å»ºè®®çš„ç´¢å¼• (é—®é¢˜4)
10. ğŸ”¹ è¯„ä¼°æ˜¯å¦éœ€è¦ç§»é™¤ NOLOCK (é—®é¢˜1)

---

## å…­ã€é¢„æœŸæ€§èƒ½æå‡

åŸºäºä»¥ä¸Šä¼˜åŒ–:

| ä¼˜åŒ–é¡¹ | é¢„æœŸæå‡ |
|--------|---------|
| ä¸´æ—¶è¡¨ç´¢å¼• | 50-70% |
| å­æŸ¥è¯¢å˜é‡åŒ– | 15-25% |
| AccountReceivable åˆå¹¶ | 20-30% |
| æ—¥æœŸè®¡ç®—ä¼˜åŒ– | 5-10% |
| MERGE è¯­å¥ | 10-20% |
| f_split ä¼˜åŒ– | 15-25% |

**æ€»ä½“é¢„æœŸ**: å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæ—¶é—´å‡å°‘ **60-80%**

**æ•°æ®ä¸€è‡´æ€§**: æ˜¾è‘—æå‡

**å¯ç»´æŠ¤æ€§**: å¤§å¹…æ”¹å–„
