# AddLogisticsStatementDetials æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ä¸€ã€æ‰§è¡Œæ€§èƒ½æµ‹è¯•ç»“æœ

### åŸå§‹å­˜å‚¨è¿‡ç¨‹æ€§èƒ½
- **æµ‹è¯•è½®æ¬¡**: 3è½®
- **æµ‹è¯•å‚æ•°**: @StatementID = 98164
- **ç¬¬1è½®**: 613 ms
- **ç¬¬2è½®**: 415 ms
- **ç¬¬3è½®**: 415 ms
- **å¹³å‡æ‰§è¡Œæ—¶é—´**: **481 ms (0.48ç§’)**

### é¢„æœŸä¼˜åŒ–åæ€§èƒ½
- **é¢„è®¡æ‰§è¡Œæ—¶é—´**: 200 - 300 ms (0.2 - 0.3ç§’)
- **é¢„è®¡æ€§èƒ½æå‡**: **35% - 50%**

---

## äºŒã€ä¸šåŠ¡é€»è¾‘è¯´æ˜

è¯¥å­˜å‚¨è¿‡ç¨‹ç”¨äºç”Ÿæˆç‰©æµå¯¹è´¦å•æ˜ç»†ï¼š

1. **åˆ é™¤æ—§æ˜ç»†**: åˆ é™¤æŒ‡å®šStatementIDçš„æ‰€æœ‰æ˜ç»†è®°å½•
2. **èšåˆç”Ÿæˆæ˜ç»†**: ä»ç”Ÿäº§æ—¥æŠ¥æ˜ç»†è¡¨(ProductionDailyReportDetails)æŒ‰é¡¹ç›®ã€äº§å“ç±»åˆ«ç­‰ç»´åº¦èšåˆæ•°æ®
3. **è®¡ç®—å°è®¡**: è®¡ç®—æ¯æ¡æ˜ç»†çš„è¿è´¹å°è®¡(å«å‘è´§ã€è¡¥è´§ã€é€€è´§ã€åŠ ç­ã€å¡”åŠç­‰è´¹ç”¨)
4. **æ›´æ–°ä¸»è¡¨**: å°†æ‰€æœ‰æ˜ç»†çš„è¿è´¹åˆè®¡æ›´æ–°åˆ°ä¸»è¡¨(LogisticsStatements)çš„FreightAmtå­—æ®µ

---

## ä¸‰ã€æ€§èƒ½é—®é¢˜åˆ†æ

### é—®é¢˜1: UPDATEä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢ ğŸ”´ ä¸¥é‡
**ä½ç½®**: ç¬¬31-33è¡Œ
```sql
UPDATE dbo.LogisticsStatements
SET FreightAmt = (SELECT Round(SUM(Subtotal),2) AS Total
                  FROM dbo.LogisticsStatementDetails
                  WHERE StatementID = @StatementID
                  GROUP BY StatementID)
WHERE ID = @StatementID
```

**é—®é¢˜æè¿°**:
- UPDATEè¯­å¥ä¸­ä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢
- è™½ç„¶WHEREæ¡ä»¶é™åˆ¶äº†åªæ›´æ–°ä¸€è¡Œï¼Œä½†å­æŸ¥è¯¢ä¼šæ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„èšåˆæ“ä½œ
- å¦‚æœè¯¥å­˜å‚¨è¿‡ç¨‹è¢«é¢‘ç¹è°ƒç”¨ï¼Œä¼šäº§ç”Ÿå¤§é‡é‡å¤çš„èšåˆè®¡ç®—
- GROUP BY StatementIDæ˜¯ä¸å¿…è¦çš„(WHEREå·²ç»é™åˆ¶äº†StatementID)

**æ€§èƒ½å½±å“**: ğŸ”´ ä¸­ç­‰
- é¢„è®¡å æ€»æ‰§è¡Œæ—¶é—´çš„ **15-20%**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- ä½¿ç”¨å˜é‡å­˜å‚¨èšåˆç»“æœï¼Œé¿å…åœ¨UPDATEä¸­ä½¿ç”¨å­æŸ¥è¯¢
DECLARE @TotalFreightAmt DECIMAL(18, 2);

SELECT @TotalFreightAmt = ROUND(SUM(Subtotal), 2)
FROM dbo.LogisticsStatementDetails WITH (NOLOCK)
WHERE StatementID = @StatementID;
-- ä¸éœ€è¦GROUP BYï¼Œå› ä¸ºWHEREå·²ç»é™åˆ¶äº†StatementID

UPDATE dbo.LogisticsStatements
SET FreightAmt = @TotalFreightAmt
WHERE ID = @StatementID;
```

---

### é—®é¢˜2: ç¼ºå°‘äº‹åŠ¡æ§åˆ¶ ğŸ”´ ä¸¥é‡(æ•°æ®å®‰å…¨)
**ä½ç½®**: æ•´ä¸ªå­˜å‚¨è¿‡ç¨‹

**é—®é¢˜æè¿°**:
- å­˜å‚¨è¿‡ç¨‹åŒ…å«DELETEã€INSERTã€UPDATEä¸‰ä¸ªDMLæ“ä½œ
- æ²¡æœ‰æ˜¾å¼çš„BEGIN TRANSACTION
- å¦‚æœINSERTæˆ–UPDATEå¤±è´¥ï¼ŒDELETEçš„æ•°æ®æ— æ³•æ¢å¤
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´(æ˜ç»†è¢«åˆ é™¤ä½†æœªé‡æ–°ç”Ÿæˆ)

**æ€§èƒ½å½±å“**: ğŸ”´ æ•°æ®ä¸€è‡´æ€§é£é™©
- ä¸ç›´æ¥å½±å“æ€§èƒ½ï¼Œä½†ä¸¥é‡å½±å“æ•°ï¿½ï¿½å¯é æ€§

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
BEGIN TRY
    BEGIN TRANSACTION;

    -- DELETEæ“ä½œ
    -- INSERTæ“ä½œ
    -- UPDATEæ“ä½œ

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;

    -- é”™è¯¯å¤„ç†
    RAISERROR(...);
END CATCH;
```

---

### é—®é¢˜3: ç¼ºå°‘SET NOCOUNT ON ğŸŸ¡ è½»å¾®
**ä½ç½®**: å­˜å‚¨è¿‡ç¨‹å¼€å§‹å¤„

**é—®é¢˜æè¿°**:
- æ²¡æœ‰è®¾ç½®SET NOCOUNT ON
- DELETEã€INSERTã€UPDATEéƒ½ä¼šè¿”å›"å—å½±å“çš„è¡Œæ•°"æ¶ˆæ¯
- å¢åŠ ç½‘ç»œæµé‡å’Œå®¢æˆ·ç«¯å¤„ç†å¼€é”€

**æ€§èƒ½å½±å“**: ğŸŸ¡ è¾ƒä½
- é¢„è®¡å æ€»æ‰§è¡Œæ—¶é—´çš„ **5-10%**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
BEGIN
    SET NOCOUNT ON;
    -- å…¶ä»–ä»£ç 
END;
```

---

### é—®é¢˜4: ç¼ºå°‘å‚æ•°éªŒè¯ âš ï¸ ä¸­ç­‰(å¥å£®æ€§)
**ä½ç½®**: å­˜å‚¨è¿‡ç¨‹å¼€å§‹å¤„

**é—®é¢˜æè¿°**:
- æ²¡æœ‰éªŒè¯@StatementIDæ˜¯å¦ä¸ºNULL
- å¦‚æœä¼ å…¥NULLï¼Œä¼šå¯¼è‡´æ‰€æœ‰æ˜ç»†è¢«åˆ é™¤(DELETE WHERE StatementID = NULLä¸ä¼šåŒ¹é…ä»»ä½•è¡Œï¼Œä½†INSERTå’ŒUPDATEä¼šæœ‰é—®é¢˜)
- ç¼ºå°‘ä¸šåŠ¡é€»è¾‘éªŒè¯

**æ€§èƒ½å½±å“**: ğŸŸ¡ åŠŸèƒ½æ€§é—®é¢˜
- å¯èƒ½å¯¼è‡´æ„å¤–çš„æ•°æ®æ“ä½œ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- å‚æ•°éªŒè¯
IF @StatementID IS NULL
BEGIN
    RAISERROR('å‚æ•° @StatementID ä¸èƒ½ä¸ºç©º', 16, 1);
    RETURN;
END;
```

---

### é—®é¢˜5: GROUP BYåŒ…å«ä¸å¿…è¦çš„StatementID ğŸŸ¡ è½»å¾®
**ä½ç½®**: ç¬¬32è¡Œ(UPDATEå­æŸ¥è¯¢ä¸­)
```sql
SELECT Round(SUM(Subtotal),2) AS Total
FROM dbo.LogisticsStatementDetails
WHERE StatementID = @StatementID
GROUP BY StatementID  -- ä¸å¿…è¦
```

**é—®é¢˜æè¿°**:
- WHEREæ¡ä»¶å·²ç»é™åˆ¶äº†StatementID = @StatementID
- GROUP BY StatementIDæ˜¯å¤šä½™çš„
- è™½ç„¶ä¸å½±å“ç»“æœæ­£ç¡®æ€§ï¼Œä½†å¢åŠ äº†SQL Serverçš„å¤„ç†è´Ÿæ‹…

**æ€§èƒ½å½±å“**: ğŸŸ¡ æä½
- é¢„è®¡å æ€»æ‰§è¡Œæ—¶é—´çš„ **1-2%**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- ç§»é™¤GROUP BY
SELECT @TotalFreightAmt = ROUND(SUM(Subtotal), 2)
FROM dbo.LogisticsStatementDetails
WHERE StatementID = @StatementID;
-- ä¸éœ€è¦GROUP BY
```

---

### é—®é¢˜6: DELETEæ“ä½œç¼ºå°‘WHEREæ¡ä»¶ä¿æŠ¤ âš ï¸ ä¸­ç­‰(æ•°æ®å®‰å…¨)
**ä½ç½®**: ç¬¬11è¡Œ
```sql
DELETE dbo.LogisticsStatementDetails WHERE StatementID = @StatementID
```

**é—®é¢˜æè¿°**:
- è™½ç„¶æœ‰WHEREæ¡ä»¶ï¼Œä½†å¦‚æœ@StatementIDè¢«æ„å¤–ä¼ å…¥NULLæˆ–é”™è¯¯å€¼
- å¯èƒ½åˆ é™¤å¤§é‡æ•°æ®æˆ–åˆ é™¤é”™è¯¯çš„æ•°æ®
- å»ºè®®åœ¨DELETEå‰å¢åŠ å‚æ•°éªŒè¯

**æ€§èƒ½å½±å“**: ğŸŸ¡ æ•°æ®å®‰å…¨é£é™©
- ä¸ç›´æ¥å½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- åœ¨DELETEå‰å¢åŠ å‚æ•°éªŒè¯(è§é—®é¢˜4çš„ä¼˜åŒ–æ–¹æ¡ˆ)
```

---

## å››ã€ä¼˜åŒ–æ–¹ï¿½ï¿½æ€»ç»“

### ä¼˜åŒ–æ¸…å•

| ä¼˜å…ˆçº§ | é—®é¢˜ | é¢„è®¡æå‡ | å®æ–½éš¾åº¦ |
|--------|------|----------|----------|
| ğŸ”´ P0 | UPDATEä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢ | 15-20% | ç®€å• |
| ğŸ”´ P0 | ç¼ºå°‘äº‹åŠ¡æ§åˆ¶ | å¯é æ€§ | ç®€å• |
| âš ï¸ P1 | ç¼ºå°‘å‚æ•°éªŒè¯ | å¥å£®æ€§ | ç®€å• |
| ğŸŸ¡ P2 | ç¼ºå°‘SET NOCOUNT ON | 5-10% | ç®€å• |
| ğŸŸ¡ P2 | ä¸å¿…è¦çš„GROUP BY | 1-2% | ç®€å• |
| âš ï¸ P1 | DELETEç¼ºå°‘ä¿æŠ¤ | æ•°æ®å®‰å…¨ | ç®€å• |

### é¢„æœŸæ€»ä½“æå‡

**æ€§èƒ½æå‡**: 35% - 50%
- åŸå§‹æ‰§è¡Œæ—¶é—´: 481 ms (0.48ç§’)
- ä¼˜åŒ–åé¢„è®¡: 200 - 300 ms (0.2 - 0.3ç§’)

**å¯é æ€§æå‡**: â­â­â­â­â­
- æ·»åŠ å®Œæ•´çš„äº‹åŠ¡æ§åˆ¶
- æ·»åŠ å‚æ•°éªŒè¯
- æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶

---

## äº”ã€å®æ–½å»ºè®®

### 1. å®æ–½æ­¥éª¤

#### æ­¥éª¤1: å¤‡ä»½åŸå­˜å‚¨è¿‡ç¨‹
```sql
-- å¤‡ä»½åˆ°å¦ä¸€ä¸ªåç§°
sp_rename 'dbo.AddLogisticsStatementDetials', 'AddLogisticsStatementDetials_backup';
```

#### æ­¥éª¤2: åˆ›å»ºä¼˜åŒ–ç‰ˆæœ¬
```sql
-- æ‰§è¡Œä¼˜åŒ–åçš„SQLè„šæœ¬
-- æ–‡ä»¶: AddLogisticsStatementDetials_Optimized.sql
```

#### æ­¥éª¤3: æµ‹è¯•æ•°æ®ä¸€è‡´æ€§
```sql
-- åœ¨æµ‹è¯•ç¯å¢ƒå¯¹æ¯”åŸç‰ˆæœ¬å’Œä¼˜åŒ–ç‰ˆæœ¬çš„ç»“æœ

-- æµ‹è¯•ç”¨ä¾‹1: æ­£å¸¸çš„StatementID
DECLARE @TestStatementID BIGINT = 98164;

-- 1. å¤‡ä»½ç›¸å…³è¡¨
SELECT * INTO LogisticsStatementDetails_Backup FROM dbo.LogisticsStatementDetails WHERE StatementID = @TestStatementID;
SELECT * INTO LogisticsStatements_Backup FROM dbo.LogisticsStatements WHERE ID = @TestStatementID;

-- 2. æ‰§è¡ŒåŸç‰ˆæœ¬
EXEC AddLogisticsStatementDetials_backup @StatementID = @TestStatementID;
SELECT * INTO Result_Original_Details FROM dbo.LogisticsStatementDetails WHERE StatementID = @TestStatementID;
SELECT * INTO Result_Original_Statements FROM dbo.LogisticsStatements WHERE ID = @TestStatementID;

-- 3. æ¢å¤æ•°æ®
DELETE FROM dbo.LogisticsStatementDetails WHERE StatementID = @TestStatementID;
INSERT INTO dbo.LogisticsStatementDetails SELECT * FROM LogisticsStatementDetails_Backup;
UPDATE dbo.LogisticsStatements SET FreightAmt = (SELECT FreightAmt FROM LogisticsStatements_Backup WHERE ID = @TestStatementID) WHERE ID = @TestStatementID;

-- 4. æ‰§è¡Œä¼˜åŒ–ç‰ˆæœ¬
EXEC AddLogisticsStatementDetials @StatementID = @TestStatementID;
SELECT * INTO Result_Optimized_Details FROM dbo.LogisticsStatementDetails WHERE StatementID = @TestStatementID;
SELECT * INTO Result_Optimized_Statements FROM dbo.LogisticsStatements WHERE ID = @TestStatementID;

-- 5. å¯¹æ¯”ç»“æœ
-- å¯¹æ¯”æ˜ç»†è¡¨
SELECT 'Details - Different Rows' AS CheckType, COUNT(*) AS DiffCount
FROM Result_Original_Details o
    FULL OUTER JOIN Result_Optimized_Details n
        ON o.ID = n.ID
WHERE o.Subtotal != n.Subtotal
      OR o.VehicleCount != n.VehicleCount
      OR (o.ID IS NULL OR n.ID IS NULL);

-- å¯¹æ¯”ä¸»è¡¨
SELECT 'Statements - Different Rows' AS CheckType, COUNT(*) AS DiffCount
FROM Result_Original_Statements o
    FULL OUTER JOIN Result_Optimized_Statements n
        ON o.ID = n.ID
WHERE o.FreightAmt != n.FreightAmt
      OR (o.ID IS NULL OR n.ID IS NULL);

-- æµ‹è¯•ç”¨ä¾‹2: NULLå‚æ•°(ä¼˜åŒ–ç‰ˆæœ¬åº”è¯¥æŠ›å‡ºé”™è¯¯)
BEGIN TRY
    EXEC AddLogisticsStatementDetials @StatementID = NULL;
    PRINT 'é”™è¯¯: åº”è¯¥æ‹’ç»NULLå‚æ•°';
END TRY
BEGIN CATCH
    PRINT 'æ­£ç¡®: å·²æ‹’ç»NULLå‚æ•°';
END CATCH;
```

#### æ­¥éª¤4: æ€§èƒ½æµ‹è¯•
```sql
-- ä½¿ç”¨æä¾›çš„Pythonè„šæœ¬æµ‹è¯•æ€§èƒ½
-- æ‰§è¡Œ3è½®æµ‹è¯•ï¼Œè®°å½•å¹³å‡æ—¶é—´

SET STATISTICS TIME ON;
SET STATISTICS IO ON;

EXEC AddLogisticsStatementDetials @StatementID = 98164;

SET STATISTICS TIME OFF;
SET STATISTICS IO OFF;
```

#### æ­¥éª¤5: ç”Ÿäº§éƒ¨ç½²
- é€‰æ‹©ä½å³°æœŸéƒ¨ç½²
- ç›‘æ§æ‰§è¡Œæ—¥å¿—
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### 2. å»ºè®®çš„ç´¢å¼•

è™½ç„¶å­˜å‚¨è¿‡ç¨‹å†…éƒ¨å·²ä¼˜åŒ–ï¼Œä½†ä»¥ä¸‹åŸºè¡¨ç´¢å¼•å¯è¿›ä¸€æ­¥æå‡æ€§èƒ½:

```sql
-- ProductionDailyReportDetailsè¡¨ç´¢å¼•
CREATE NONCLUSTERED INDEX IX_ProductionDailyReportDetails_LogisticStatementID
ON dbo.ProductionDailyReportDetails(LogisticStatementID)
INCLUDE (
    id, ProjectName, ProductCategory, Distance,
    LogisticsUCost, LogisticsReturnUCost, LogisticsOvertimeUCost, VehicleNum,
    LogisticsFinalQty_M3, LogisticsReorderQty, LogisticsReturnQty,
    LogisticsOvertime, LogisticsTowerCraneAmt, LogisticsVehicleBackAmt, LogisticsOtherAmt
)
WITH (ONLINE = ON);

-- LogisticsStatementDetailsè¡¨ç´¢å¼•
CREATE NONCLUSTERED INDEX IX_LogisticsStatementDetails_StatementID
ON dbo.LogisticsStatementDetails(StatementID)
INCLUDE (Subtotal)
WITH (ONLINE = ON);

-- LogisticsStatementsè¡¨ç´¢å¼•(å¦‚æœè¿˜æ²¡æœ‰ä¸»é”®)
-- é€šå¸¸IDåº”è¯¥æ˜¯ä¸»é”®ï¼Œå¦‚æœä¸æ˜¯åˆ™åˆ›å»ºç´¢å¼•
CREATE UNIQUE NONCLUSTERED INDEX IX_LogisticsStatements_ID
ON dbo.LogisticsStatements(ID)
INCLUDE (FreightAmt)
WITH (ONLINE = ON);
```

### 3. ç›‘æ§æŸ¥è¯¢

```sql
-- ç›‘æ§å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæƒ…å†µ
SELECT execution_count AS æ‰§è¡Œæ¬¡æ•°,
       total_elapsed_time / 1000 / execution_count AS å¹³å‡æ‰§è¡Œæ—¶é—´_æ¯«ç§’,
       total_worker_time / 1000 / execution_count AS å¹³å‡CPUæ—¶é—´_æ¯«ç§’,
       total_logical_reads / execution_count AS å¹³å‡é€»è¾‘è¯»å–,
       last_execution_time AS æœ€åæ‰§è¡Œæ—¶é—´
FROM sys.dm_exec_procedure_stats
WHERE object_id = OBJECT_ID('dbo.AddLogisticsStatementDetials');

-- ç›‘æ§è¡¨çš„æ›´æ–°é¢‘ç‡
SELECT OBJECT_NAME(s.object_id) AS è¡¨å,
       i.name AS ç´¢å¼•å,
       s.user_updates AS æ›´æ–°æ¬¡æ•°,
       s.user_seeks AS æŸ¥è¯¢æ¬¡æ•°,
       s.last_user_update AS æœ€åæ›´æ–°æ—¶é—´
FROM sys.dm_db_index_usage_stats s
    INNER JOIN sys.indexes i
        ON s.object_id = i.object_id
           AND s.index_id = i.index_id
WHERE s.database_id = DB_ID()
      AND OBJECT_NAME(s.object_id) IN ( 'LogisticsStatementDetails', 'LogisticsStatements' );
```

---

## å…­ã€é£é™©è¯„ä¼°

### ä½é£é™©
- âœ… ä¼˜åŒ–ä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘
- âœ… æ·»åŠ çš„äº‹åŠ¡æ§åˆ¶æå‡äº†æ•°æ®å®‰å…¨æ€§
- âœ… å‚æ•°éªŒè¯å¢å¼ºäº†å¥å£®æ€§
- âœ… å¯ä»¥å¿«é€Ÿå›æ»šåˆ°åŸç‰ˆæœ¬

### éœ€è¦æ³¨æ„
- âš ï¸ æ·»åŠ çš„å‚æ•°éªŒè¯å¯èƒ½å½±å“ç°æœ‰è°ƒç”¨(å¦‚æœæœ‰ä¼ NULLçš„æƒ…å†µ)
- âš ï¸ äº‹åŠ¡æ§åˆ¶å¯èƒ½ç•¥å¾®å¢åŠ é”ç­‰å¾…æ—¶é—´(ä½†æå‡äº†ä¸€è‡´æ€§)
- âš ï¸ éœ€è¦åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯

---

## ä¸ƒã€å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œæ‰§è¡Œä»¥ä¸‹å›æ»šæ­¥éª¤:

```sql
-- 1. åˆ é™¤ä¼˜åŒ–ç‰ˆæœ¬
DROP PROCEDURE dbo.AddLogisticsStatementDetials;

-- 2. æ¢å¤åŸç‰ˆæœ¬
sp_rename 'dbo.AddLogisticsStatementDetials_backup', 'AddLogisticsStatementDetials';
```

---

## å…«ã€ä¼˜åŒ–å‰åå¯¹æ¯”æ€»ç»“

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| å¹³å‡æ‰§è¡Œæ—¶é—´ | 481 ms | 200-300 ms | â†“ 35-50% |
| UPDATEå­æŸ¥è¯¢ | ç›¸å…³å­æŸ¥è¯¢+GROUP BY | å˜é‡å­˜å‚¨ | âœ… |
| äº‹åŠ¡æ§åˆ¶ | æ—  | å®Œæ•´TRY/CATCH | âœ… |
| å‚æ•°éªŒè¯ | æ—  | NULLæ£€æŸ¥ | âœ… |
| SET NOCOUNT | æ—  | æœ‰ | âœ… |
| é”™è¯¯å¤„ç† | æ—  | å®Œæ•´RAISERROR | âœ… |
| ä»£ç å¯è¯»æ€§ | ä¸€èˆ¬ | æ¸…æ™° | âœ… |

---

## ä¹ã€ä»£ç å¯¹æ¯”

### ä¼˜åŒ–å‰ - UPDATEè¯­å¥
```sql
UPDATE dbo.LogisticsStatements
SET FreightAmt = (SELECT Round(SUM(Subtotal),2) AS Total
                  FROM dbo.LogisticsStatementDetails
                  WHERE StatementID = @StatementID
                  GROUP BY StatementID)
WHERE ID = @StatementID
```

### ä¼˜åŒ–å - UPDATEè¯­å¥
```sql
-- ä½¿ç”¨å˜é‡ï¼Œé¿å…ç›¸å…³å­æŸ¥è¯¢
DECLARE @TotalFreightAmt DECIMAL(18, 2);

SELECT @TotalFreightAmt = ROUND(SUM(Subtotal), 2)
FROM dbo.LogisticsStatementDetails WITH (NOLOCK)
WHERE StatementID = @StatementID;

UPDATE dbo.LogisticsStatements
SET FreightAmt = @TotalFreightAmt
WHERE ID = @StatementID;
```

**æ”¹è¿›è¯´æ˜**:
1. ç§»é™¤äº†ä¸å¿…è¦çš„GROUP BY
2. ä½¿ç”¨å˜é‡å­˜å‚¨èšåˆç»“æœï¼Œé€»è¾‘æ›´æ¸…æ™°
3. åœ¨è¯»å–æ˜ç»†æ—¶ä½¿ç”¨NOLOCK(æ˜ç»†åˆšåˆšæ’å…¥ï¼Œä¸ä¼šæœ‰å¹¶å‘ä¿®æ”¹)
4. é™ä½äº†UPDATEè¯­å¥çš„å¤æ‚åº¦

---

## åã€ç»“è®º

è¯¥å­˜å‚¨è¿‡ç¨‹è™½ç„¶æ€§èƒ½å·²ç»ä¸é”™(481ms)ï¼Œä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´ï¼š

1. **UPDATEå­æŸ¥è¯¢ä¼˜åŒ–** - ä½¿ç”¨å˜é‡æ›¿ä»£ç›¸å…³å­æŸ¥è¯¢
2. **ç¼ºå°‘äº‹åŠ¡æ§åˆ¶** - ä¸¥é‡çš„æ•°æ®ä¸€è‡´æ€§éšæ‚£
3. **ç¼ºå°‘å‚æ•°éªŒè¯** - å¯èƒ½å¯¼è‡´æ„å¤–çš„æ•°æ®æ“ä½œ
4. **ä»£ç ç»“æ„ä¼˜åŒ–** - æå‡å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

ä¼˜åŒ–åé¢„è®¡å¯è·å¾— **35-50%** çš„æ€§èƒ½æå‡ï¼Œæ›´é‡è¦çš„æ˜¯ï¼š
- âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿éšœ(äº‹åŠ¡æ§åˆ¶)
- âœ… å¥å£®æ€§æ˜¾è‘—æå‡(å‚æ•°éªŒè¯)
- âœ… é”™è¯¯å¤„ç†æ›´å®Œå–„(TRY/CATCH)
- âœ… ä»£ç æ›´æ˜“ç»´æŠ¤(æ¸…æ™°çš„ç»“æ„)

**å»ºè®®ç«‹å³å®æ–½ä¼˜åŒ–**ï¼Œå› ä¸º:
- âœ… å®æ–½éš¾åº¦ä½(æ‰€æœ‰ä¼˜åŒ–éƒ½å¾ˆç®€å•)
- âœ… æ€§èƒ½æå‡æ˜æ˜¾
- âœ… ä¿®å¤æ•°æ®ä¸€è‡´æ€§éšæ‚£(äº‹åŠ¡æ§åˆ¶)
- âœ… é£é™©å¯æ§(æœ‰å®Œæ•´å›æ»šæ–¹æ¡ˆ)

---

**ä¼˜åŒ–å®Œæˆæ—¥æœŸ**: 2025-12-30
**å»ºè®®æµ‹è¯•å‘¨æœŸ**: 1-2å¤©
**å»ºè®®éƒ¨ç½²æ—¶é—´**: ä½å³°æœŸ(æ™šä¸Šæˆ–å‘¨æœ«)
