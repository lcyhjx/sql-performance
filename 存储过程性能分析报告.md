# SQL Server 存储过程性能分析报告

**数据库:** Statistics-CT-test
**分析时间:** 2025-12-28 22:12:44
**生成工具:** analyze_stored_procedures.py

---

## 执行摘要

| 指标 | 数值 |
|------|------|
| 总存储过程数 | 185 |
| 成功执行 | 146 (78.9%) |
| 执行失败 | 39 (21.1%) |

---

## 性能排名 - 最慢的10个存储过程

### Top 1: dbo.CashFlowBalance
- **执行时间:** 44,315.24 ms (44.3秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @beginDate (datetime)
  - @endDate (datetime)
- **性能建议:** 这是最慢的存储过程，需要优先优化。可能涉及大量数据聚合或跨服务器查询。

### Top 2: dbo.usp_UpdateProjectRiskRelationInfo
- **执行时间:** 12,717.45 ms (12.7秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:** 无
- **性能建议:** 第二慢的存储过程，建议检查是否有未索引的大表JOIN操作。

### Top 3: dbo.usp_CheckProjectRiskWarn_Contract
- **执行时间:** 10,946.41 ms (10.9秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @Type (int)
  - @ProjectID (bigint)
- **性能建议:** 项目风险检查相关，可能包含复杂的业务逻辑。

### Top 4: dbo.usp_CheckProjectRiskWarn_Settlement
- **执行时间:** 5,915.44 ms (5.9秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @Type (int)
  - @ProjectID (bigint)

### Top 5: dbo.usp_UpdateProjectProgess
- **执行时间:** 5,711.02 ms (5.7秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:** 无

### Top 6: dbo.AddLogisticsStatementDetials
- **执行时间:** 5,379.74 ms (5.4秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @StatementID (bigint)

### Top 7: dbo.usp_GenerateWorkbenchKanban_Business_Station
- **执行时间:** 3,362.06 ms (3.4秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:** 无

### Top 8: dbo.usp_GenerateProjectReturnPlansData
- **执行时间:** 2,996.36 ms (3.0秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @PeriodID (bigint)
  - @Operator (nvarchar)

### Top 9: dbo.P_SalesExpenseSummary
- **执行时间:** 2,080.17 ms (2.1秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @periodid (bigint)
  - @Rptid (bigint)

### Top 10: dbo.usp_InitMaterialUPriceCostAccountingData
- **执行时间:** 2,062.89 ms (2.1秒)
- **CPU时间:** 0 ms
- **逻辑读取:** 0
- **参数:**
  - @PeriodID (bigint)
  - @Operator (nvarchar)

---

## 执行失败分析

共有 **39个** 存储过程执行失败，主要失败原因：

### 1. 跨服务器连接失败
**错误信息:** "Could not find server '172.16.199.200' in sys.servers"

受影响的存储过程包括：
- usp_AutoGenerateMaterialUsageDailyReports
- usp_AutoGenerateProductionDailyReports
- usp_AutoGenerateReceivingDailyReports
- usp_AutoPriceSalesDailyReportDetails
- usp_FindCalcPriceAbnormalData
- 等多个存储过程

**原因分析:** 这些存储过程依赖于链接服务器(Linked Server)，但测试环境未配置这些服务器连接。

**建议:**
- 检查是否需要在测试环境配置链接服务器
- 或者修改存储过程使用其他数据同步方式

### 2. 临时表不存在
**错误信息:** "Invalid object name '#TempDataUsePrice'"

受影响的存储过程：
- usp_AutoPriceSalesDailyReportDetails_Logistics
- usp_AutoPriceSalesDailyReportDetails_Overtime
- usp_AutoPriceSalesDailyReportDetails_Pump
- 等

**原因分析:** 这些存储过程依赖于其他存储过程创建的临时表，单独执行时会失败。

**建议:** 这些是级联调用的存储过程，需要按正确的顺序执行。

### 3. 参数值无效
**错误信息:** "A TOP or FETCH clause contains an invalid value"

受影响的存储过程：
- sp_getContractInfosByLastModifyDate

**原因分析:** 传入了NULL参数导致TOP子句值无效。

---

## 性能优化建议

### 高优先级（立即处理）

1. **优化 dbo.CashFlowBalance**
   - 执行时间超过44秒，严重影响用户体验
   - 建议：添加适当索引，考虑数据分区或缓存策略

2. **优化项目风险检查系列存储过程**
   - usp_CheckProjectRiskWarn_Contract (10.9秒)
   - usp_CheckProjectRiskWarn_Settlement (5.9秒)
   - 建议：检查JOIN条件，添加必要的索引

### 中优先级（本周处理）

3. **解决跨服务器连接问题**
   - 39个失败中大部分是由于链接服务器未配置
   - 建议：配置必要的链接服务器或重构相关逻辑

4. **优化数据生成类存储过程**
   - 多个 "Generate" 开头的存储过程执行时间较长
   - 建议：考虑异步处理或批量优化

### 低优先级（长期改进）

5. **审查所有执行时间超过1秒的存储过程**
   - 共有约20个存储过程执行时间超过1秒
   - 建议：逐步优化，设定性能基线

6. **建立性能监控机制**
   - 定期运行此分析脚本
   - 跟踪性能趋势
   - 设置性能告警阈值

---

## 注意事项

1. **测试环境限制**
   - 本次分析在测试环境进行
   - 所有参数使用NULL值执行，可能与实际业务场景不同
   - 实际生产环境的性能可能有所不同

2. **CPU时间为0的说明**
   - 所有存储过程的CPU时间显示为0ms
   - 这可能是因为SQL Server统计信息未正确捕获
   - 需要进一步配置才能获取准确的CPU时间统计

3. **逻辑读取为0的说明**
   - 大部分存储过程的逻辑读取显示为0
   - 这可能因为使用NULL参数导致早期退出
   - 建议在实际业务场景下重新测试

---

## 后续步骤

1. ✅ 已完成存储过程性能基线测试
2. ⏭ 与开发团队讨论优化优先级
3. ⏭ 配置链接服务器或修改相关存储过程
4. ⏭ 针对Top 10最慢存储过程进行详细分析
5. ⏭ 建立定期性能监控机制

---

## 附件

详细的JSON格式报告：[performance_report.json](performance_report.json)

**报告生成时间:** 2025-12-28
**工具版本:** analyze_stored_procedures.py v1.0